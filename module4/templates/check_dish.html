{% extends 'base.html' %}
{% load static %}
{% block meta %}
<title>Check Pending Dish</title>
{% endblock meta %}

{% block content %}
{% include 'navbar.html' %}

{# Add CSRF Token #}
{% csrf_token %}

<h1 class="text-3xl font-bold mb-8">Pending Dishes</h1>

<!-- Search bar -->
<div class="flex justify-between items-center mb-4 p-4 bg-white shadow-md rounded-lg">
  <input type="text" id="searchInput" placeholder="Search dish" class="px-4 py-2 w-full bg-gray-100 border border-gray-300 rounded-lg focus:outline-none">
</div>

<!-- Table -->
{% if pending_dishes %}
  <div class="mx-2">
    <table class="table-auto w-full text-left bg-white shadow-md rounded-lg overflow-hidden">
      <thead class="rounded-t-lg">
        <tr class="bg-gray-200 text-gray-600 text-sm leading-normal">
          <th class="px-4 py-2">Name</th>
          <th class="px-4 py-2">Vendor Name</th>
          <th class="px-4 py-2">Price</th>
          <th class="px-4 py-2" style="width: 100px;">Category</th>
          <th class="px-4 py-2">Address</th>
          <th class="px-4 py-2" style="width: 80px; text-align:center">Approve</th>
          <th class="px-2 py-2" style="width: 80px; text-align:center">Delete</th>
        </tr>
      </thead>
      <tbody id="dishesTable" class="rounded-b-lg">
        {% for dish in pending_dishes %}
          <tr id="dish-row-{{ dish.id }}" class="hover:bg-gray-100 border-b border-gray-200">
            <td class="border px-4 py-2">{{ dish.name }}</td>
            <td class="border px-4 py-2">{{ dish.vendor_name }}</td>
            <td class="border px-4 py-2">{{ dish.price }}</td>
            <td class="border px-4 py-2" style="width: 100px;">{{ dish.category }}</td>
            <td class="border px-4 py-2">{{ dish.address }}</td>
            <!-- Approve Button -->
            <td class="border px-4 py-2 text-center" style="width: 80px;">
              <button 
                type="button" 
                class="bg-green-500 hover:bg-green-700 text-white rounded-full p-2 transition duration-300 shadow-md approve-dish-btn"
                data-dish-id="{{ dish.id }}">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                  <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 00-1.414 0L9 11.586 6.707 9.293a1 1 0 10-1.414 1.414l3 3a1 1 0 001.414 0l7-7a1 1 0 000-1.414z" clip-rule="evenodd" />
                </svg>
              </button>            
            </td>

            <!-- Delete Button -->
            <td class="border px-4 py-2 text-center">
              <button 
                type="button" 
                class="bg-red-500 hover:bg-red-700 text-white rounded-full p-2 transition duration-300 shadow-md delete-dish-btn"
                data-dish-id="{{ dish.id }}">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                  <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 011.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                </svg>
              </button>
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
{% else %}
  <p>No pending dishes.</p>
{% endif %}

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Get CSRF token
    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    console.log('CSRF Token loaded:', csrftoken ? 'Yes' : 'No');

    // Approve Dish via AJAX
    document.querySelectorAll('.approve-dish-btn').forEach(button => {
        button.addEventListener('click', function() {
            const dishId = this.dataset.dishId;
            const approveUrl = "{% url 'module4:approve_dish' 0 %}".replace('0', dishId);
            
            // Debug information
            console.log('Approving dish:', dishId);
            console.log('Approve URL:', approveUrl);

            fetch(approveUrl, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrftoken,
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: new URLSearchParams({
                    'action': 'approve'
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('Server response:', data);
                if (data.status === 'approved') {
                    document.getElementById(`dish-row-${dishId}`).remove();
                    console.log('Dish approved successfully');
                } else {
                    console.error('Failed to approve dish:', data);
                    alert('Failed to approve dish. Please try again.');
                }
            })
            .catch(error => {
                console.error('Error during approve:', error);
                alert('An error occurred while approving the dish. Please check the console for details.');
            });
        });
    });

    // Delete Dish via AJAX
    document.querySelectorAll('.delete-dish-btn').forEach(button => {
        button.addEventListener('click', function() {
            const dishId = this.dataset.dishId;
            const deleteUrl = "{% url 'module4:approve_dish' 0 %}".replace('0', dishId);
            
            // Debug information
            console.log('Deleting dish:', dishId);
            console.log('Delete URL:', deleteUrl);

            fetch(deleteUrl, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrftoken,
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: new URLSearchParams({
                    'action': 'delete'
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('Server response:', data);
                if (data.status === 'deleted') {
                    document.getElementById(`dish-row-${dishId}`).remove();
                    console.log('Dish deleted successfully');
                } else {
                    console.error('Failed to delete dish:', data);
                    alert('Failed to delete dish. Please try again.');
                }
            })
            .catch(error => {
                console.error('Error during delete:', error);
                alert('An error occurred while deleting the dish. Please check the console for details.');
            });
        });
    });

    // Search Functionality
    document.getElementById('searchInput').addEventListener('input', function() {
        const searchValue = this.value.toLowerCase().trim();
        const rows = document.querySelectorAll('#dishesTable tr');
        
        rows.forEach(row => {
            const nameCell = row.querySelector('td:first-child');
            if (nameCell) {
                const name = nameCell.textContent.toLowerCase().trim();
                if (name.startsWith(searchValue)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            }
        });
    });
});
</script>

{% endblock content %}