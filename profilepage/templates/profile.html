{% extends 'base.html' %}
{% load static %}

{% block content %}
{% include 'navbar.html' %}
<div class="max-w-6xl mx-auto px-4 py-8">
    <div class="text-center mb-8 pt-20">
        <img id="profile-image" src="{{ profile_user.image_url|default:'https://via.placeholder.com/150' }}" alt="{{ profile_user.username }}" class="w-32 h-32 rounded-full mx-auto mb-4 object-cover">
        <h1 id="profile-username" class="text-3xl font-bold">{{ profile_user.username|default:'John Doe' }}</h1>
        <p id="profile-name" class="text-gray-600">{{ profile_user.first_name|default:'' }} {{ profile_user.last_name|default:'' }}</p>
        <p id="profile-location" class="text-gray-600">{{ profile_user.location|default:'Malang, Indonesia' }}</p>
        <p id="profile-description" class="text-gray-600 mt-4">{{ profile_user.profile.description|default:'No description available.' }}</p>
        <div class="flex justify-center space-x-8 my-6">
            <div class="text-center">
                <span class="block text-2xl font-bold">{{ favorite_dishes_count|default:'5' }}</span>
                <span class="text-sm text-gray-500">Favorite Dishes</span>
            </div>
            <div class="text-center">
                <span class="block text-2xl font-bold">{{ reviewed_dishes_count|default:'12' }}</span>
                <span class="text-sm text-gray-500">Reviewed Dishes</span>
            </div>
            <div class="text-center">
                <span class="block text-2xl font-bold">{{ forum_comments_count|default:'23' }}</span>
                <span class="text-sm text-gray-500">Forum Comments</span>
            </div>
        </div>
        
        <div class="space-x-4 mt-4">
            {% if user == profile_user %}
                <button id="edit-profile-btn" class="inline-block px-4 py-2 bg-[#AB4A2F] text-white rounded hover:bg-[#F18F73] transition">
                    Edit Profile
                </button>
                <a href="{% url 'main:logout' %}" class="inline-block px-4 py-2 bg-[#FDC66B] text-white rounded hover:bg-[#F18F73] transition">
                    Logout
                </a>
            {% else %}
                <button class="inline-block px-4 py-2 bg-[#FDC66B] text-white rounded hover:bg-[#F18F73] transition">
                    Like Profile
                </button>
            {% endif %}
        </div>
    </div>
    
    <div class="space-y-8">
        <div>
            <h2 class="text-2xl font-bold mb-4">Favorite Dishes</h2>
            <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                {% for dish in favorite_dishes %}
                <div class="bg-white rounded shadow overflow-hidden">
                    <img src="{{ dish.image|default:'https://via.placeholder.com/300x200?text=No+Image' }}" alt="{{ dish.name }}" class="w-full h-40 object-cover">
                    <div class="p-2">
                        <p class="font-medium">{{ dish.name }}</p>
                        <p class="text-sm text-gray-600">Type: {{ dish.category }}</p>
                        <p class="text-sm text-gray-600">Flavor: {{ dish.flavor }}</p>
                        <p class="text-sm text-gray-600">Price: Rp.{{ dish.price }},00</p>
                        <p class="text-sm text-gray-600">Vendor: {{ dish.vendor_name }}</p>
                        <a href="{{ dish.map_link }}" target="_blank" class="text-sm text-blue-600 hover:underline">Location</a>
                    </div>
                </div>
                {% empty %}
                <p class="col-span-3 text-center text-gray-600">No favorite dishes added yet.</p>
                {% endfor %}
            </div>
            <div class="mt-4 text-center">
                <a href="{% url 'MyFavoriteDishes:show_favorite' %}" class="inline-block px-4 py-2 bg-[#AB4A2F] text-white rounded hover:bg-[#F18F73] transition">
                    View All Favorites ({{ favorite_dishes_count }})
                </a>
            </div>
        </div>
        
        <div>
            <h2 class="text-2xl font-bold mb-4">Reviewed Dishes</h2>
            <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                {% for i in '123'|make_list %}
                <div class="bg-white rounded shadow overflow-hidden">
                    <img src="https://via.placeholder.com/300x200?text=Reviewed+Dish" alt="Placeholder" class="w-full h-40 object-cover">
                    <div class="p-2">
                        <p class="font-medium">Tasty Meal {{ forloop.counter }}</p>
                        <p class="text-sm text-gray-600">Rating: {{ forloop.counter|add:"2" }}/5</p>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        
        <div>
            <h2 class="text-2xl font-bold mb-4">Forum Comments</h2>
            <div class="space-y-4">
                {% for i in '123'|make_list %}
                <div class="bg-gray-100 rounded p-4">
                    <p class="text-gray-800">"This is a placeholder comment about a delicious dish. It's really tasty and I recommend it to everyone!"</p>
                    <p class="text-sm text-gray-600 mt-2">on Tasty Discussion Thread {{ forloop.counter }} - Jan {{ forloop.counter }}, 2024</p>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<!-- Edit Profile Modal (Initially Hidden) -->
<div id="edit-profile-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden flex items-center justify-center">
    <div class="relative p-8 border w-full max-w-2xl shadow-lg rounded-md bg-white transform transition-all duration-300 scale-95 opacity-0">
        <div class="mt-3">
            <h3 class="text-2xl leading-6 font-bold text-gray-900 text-center mb-6">Edit Profile</h3>
            <form id="profile-form" class="text-left">
                <div class="grid grid-cols-2 gap-6">
                    <div class="col-span-2 sm:col-span-1">
                        <label for="edit-first-name" class="block text-gray-700 text-sm font-bold mb-2">First Name:</label>
                        <input type="text" id="edit-first-name" name="first_name" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                    </div>
                    <div class="col-span-2 sm:col-span-1">
                        <label for="edit-last-name" class="block text-gray-700 text-sm font-bold mb-2">Last Name:</label>
                        <input type="text" id="edit-last-name" name="last_name" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                    </div>
                    <div class="col-span-2">
                        <label for="edit-location" class="block text-gray-700 text-sm font-bold mb-2">Location:</label>
                        <input type="text" id="edit-location" name="location" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                    </div>
                    <div class="col-span-2">
                        <label for="edit-image-url" class="block text-gray-700 text-sm font-bold mb-2">Profile Image URL:</label>
                        <input type="text" id="edit-image-url" name="image_url" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                    </div>
                    <div class="col-span-2 mt-4">
                        <label for="edit-description" class="block text-gray-700 text-sm font-bold mb-2">Description:</label>
                        <textarea id="edit-description" name="description" rows="4" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"></textarea>
                    </div>
                </div>
                <div class="flex items-center justify-end mt-8 space-x-4">
                    <button type="button" id="cancel-edit" class="bg-[#FDC66B] hover:bg-[#F18F73] text-white font-bold py-2 px-6 rounded focus:outline-none focus:shadow-outline transition duration-300">Cancel</button>
                    <button type="submit" id="save-profile" class="bg-[#AB4A2F] hover:bg-[#F18F73] text-white font-bold py-2 px-6 rounded focus:outline-none focus:shadow-outline transition duration-300">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.5/purify.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const editBtn = document.getElementById('edit-profile-btn');
    const editModal = document.getElementById('edit-profile-modal');
    const modalContent = editModal.querySelector('div');
    const cancelBtn = document.getElementById('cancel-edit');
    const profileForm = document.getElementById('profile-form');
    const saveBtn = document.getElementById('save-profile');

    function showEditModal() {
        editModal.classList.remove('hidden');
        setTimeout(() => {
            modalContent.classList.remove('scale-95', 'opacity-0');
            modalContent.classList.add('scale-100', 'opacity-100');
        }, 10);
        // Populate form with current values
        const fullName = document.getElementById('profile-name').textContent.split(' ');
        document.getElementById('edit-first-name').value = fullName[0] || '';
        document.getElementById('edit-last-name').value = fullName[1] || '';
        document.getElementById('edit-location').value = document.getElementById('profile-location').textContent;
        document.getElementById('edit-image-url').value = document.getElementById('profile-image').src;
        document.getElementById('edit-description').value = document.getElementById('profile-description').textContent;
    }

    function hideEditModal() {
        modalContent.classList.remove('scale-100', 'opacity-100');
        modalContent.classList.add('scale-95', 'opacity-0');
        setTimeout(() => {
            editModal.classList.add('hidden');
        }, 300);
    }

    editBtn.addEventListener('click', showEditModal);
    cancelBtn.addEventListener('click', hideEditModal);

    // Close modal when clicking outside of it
    editModal.addEventListener('click', function(event) {
        if (event.target === editModal) {
            hideEditModal();
        }
    });

    profileForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(profileForm);
        
        // Sanitize form inputs
        for (let pair of formData.entries()) {
            formData.set(pair[0], DOMPurify.sanitize(pair[1]));
        }

        fetch('{% url "profilepage:edit_profile" username=profile_user.username %}', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Update profile information with sanitized data
                document.getElementById('profile-name').textContent = `${DOMPurify.sanitize(data.first_name)} ${DOMPurify.sanitize(data.last_name)}`;
                document.getElementById('profile-location').textContent = DOMPurify.sanitize(data.location);
                document.getElementById('profile-image').src = DOMPurify.sanitize(data.image_url);
                document.getElementById('profile-description').textContent = DOMPurify.sanitize(data.description) || 'No description available.';
                hideEditModal();
            } else {
                alert('Failed to update profile: ' + (data.message || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while updating the profile');
        });
    });

    // Function to get CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
});
</script>
{% endblock %}
